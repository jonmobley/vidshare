<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Dropbox App for VidShare</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #f8f9fa;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
        }
        
        h2 {
            color: #667eea;
            border-bottom: 3px solid #e9ecef;
            padding-bottom: 10px;
            margin: 40px 0 20px 0;
            font-size: 1.5rem;
        }
        
        .step {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin: 25px 0;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: absolute;
            left: -17px;
            top: 20px;
            font-size: 14px;
        }
        
        .step h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.2rem;
        }
        
        .step ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .step li {
            margin: 8px 0;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #856404;
        }
        
        .code {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #155724;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #856404;
        }
        
        .token-section {
            background: #e8f4fd;
            border: 2px solid #b3d7ff;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .token-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
            min-height: 120px;
            resize: vertical;
            line-height: 1.4;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        }
        
        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 13px;
            display: none;
            line-height: 1.5;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .screenshot-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            color: #6c757d;
            font-style: italic;
        }
        
        a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        .link-button {
            background: #667eea;
            color: white !important;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none !important;
            display: inline-block;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .link-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Create New Dropbox App for VidShare</h1>
        
        <div class="success">
            <strong>‚ú® Fresh Start!</strong> Creating a new Dropbox app is often the best solution. This ensures you have the right permissions and a clean token.
        </div>

        <h2>Step 1: Create New Dropbox App</h2>
        
        <div class="step">
            <div class="step-number">1</div>
            <h3>üåê Go to Dropbox Developer Console</h3>
            <p>Click the button below to open the Dropbox Developer Console:</p>
            <a href="https://www.dropbox.com/developers/apps" target="_blank" class="link-button">
                üîó Open Dropbox Developer Console
            </a>
            <p>Sign in with your Dropbox account if you haven't already.</p>
        </div>

        <div class="step">
            <div class="step-number">2</div>
            <h3>‚ûï Create App</h3>
            <p>Click the <span class="highlight">"Create app"</span> button and choose these settings:</p>
            <ul>
                <li><strong>Choose an API:</strong> <span class="highlight">Scoped access</span></li>
                <li><strong>Choose the type of access you need:</strong> <span class="highlight">Full Dropbox</span></li>
                <li><strong>Name your app:</strong> <code>VidShare-[YourName]</code> (or any unique name)</li>
            </ul>
            <div class="code">
‚úÖ API: Scoped access
‚úÖ Access: Full Dropbox  
‚úÖ Name: VidShare-YourName</div>
        </div>

        <h2>Step 2: Configure App Permissions</h2>
        
        <div class="step">
            <div class="step-number">3</div>
            <h3>‚öôÔ∏è Set Permissions</h3>
            <p>After creating the app, go to the <span class="highlight">"Permissions"</span> tab and enable these scopes:</p>
            <div class="code">
‚úÖ files.metadata.read
‚úÖ files.content.read  
‚úÖ sharing.read</div>
            <div class="warning">
                <strong>Important:</strong> You must click <span class="highlight">"Submit"</span> after selecting the permissions!
            </div>
        </div>

        <h2>Step 3: Generate Access Token</h2>
        
        <div class="step">
            <div class="step-number">4</div>
            <h3>üîë Generate Token</h3>
            <p>Go to the <span class="highlight">"Settings"</span> tab and scroll down to the <strong>"OAuth 2"</strong> section:</p>
            <ul>
                <li>Under <strong>"Generated access token"</strong>, click <span class="highlight">"Generate"</span></li>
                <li>Copy the entire token (it will be very long and start with <code>sl.</code>)</li>
                <li>The token will look something like: <code>sl.u.ABC123...</code></li>
            </ul>
        </div>

        <h2>Step 4: Test & Save Your New Token</h2>
        
        <div class="token-section">
            <h3>üß™ Paste Your New Token Here</h3>
            <p>Paste the complete token you just generated from your new Dropbox app:</p>
            <textarea id="newToken" class="token-input" placeholder="Paste your new Dropbox token here...

Example: sl.u.AFwbb7m2yDRyK2JBnWdr_xYV3witrru-PAeyzSBJLivwCkAAqbyUwWEPo6ze2SyeBDTIny8aQfCuAoJux5j8uPjiMU_NYcQ0EUTF7sf_tS8t_6j4_xvyTKzr..."></textarea>
            
            <button class="btn btn-info" onclick="validateToken()">üîç Test Token</button>
            <button class="btn btn-success" onclick="saveToken()">üíæ Save to VidShare</button>
            
            <div id="tokenResult" class="result"></div>
        </div>

        <h2>Step 5: Test Your VidShare App</h2>
        
        <div class="step">
            <div class="step-number">5</div>
            <h3>üéâ Ready to Use!</h3>
            <p>After saving your token, test your VidShare app:</p>
            <button class="btn" onclick="openAdminPanel()">üé¨ Open Admin Panel</button>
            <button class="btn btn-info" onclick="runFullTest()">üß™ Run Full Test</button>
        </div>

        <div class="success" id="finalSuccess" style="display: none;">
            <h3>üéâ Congratulations!</h3>
            <p>Your VidShare app is now fully functional with a fresh Dropbox connection! You can:</p>
            <ul>
                <li>‚úÖ Create galleries from any Dropbox folder</li>
                <li>‚úÖ Share videos with custom short URLs</li>
                <li>‚úÖ View galleries on any device</li>
                <li>‚úÖ Manage all your video content</li>
            </ul>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://gnfxpqlfqjxtuthoplpx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZnhwcWxmcWp4dHV0aG9wbHB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MzYxODgsImV4cCI6MjA2NDMxMjE4OH0.ymqy7Igd530LuJvj-u_SU_1iGJBTLZAig1vAYmDPX20';
        
        function showResult(message, type = 'info') {
            const element = document.getElementById('tokenResult');
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        async function validateToken() {
            const token = document.getElementById('newToken').value.trim();
            
            if (!token) {
                showResult('‚ùå Please paste your Dropbox token first.', 'error');
                return false;
            }
            
            if (!token.startsWith('sl.')) {
                showResult('‚ùå Invalid token format. Token should start with "sl."', 'error');
                return false;
            }
            
            showResult('üîç Testing your new token with Dropbox API...', 'info');
            
            try {
                const response = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Token is invalid, expired, or permissions are incorrect. Please check your app permissions.');
                    }
                    if (response.status === 400) {
                        throw new Error('Bad request. Make sure you copied the complete token.');
                    }
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const userData = await response.json();
                showResult(`‚úÖ Token is valid and working perfectly!

Connected to Dropbox account:
üë§ Name: ${userData.name.display_name}
üìß Email: ${userData.email}
üÜî Account ID: ${userData.account_id}

Your token has the correct permissions and is ready to use!`, 'success');
                return true;
                
            } catch (error) {
                let errorMessage = `‚ùå Token validation failed: ${error.message}`;
                
                if (error.message.includes('permissions')) {
                    errorMessage += `

üí° Solution: 
1. Go back to your Dropbox app settings
2. Check the "Permissions" tab
3. Make sure these are enabled:
   ‚úÖ files.metadata.read
   ‚úÖ files.content.read
   ‚úÖ sharing.read
4. Click "Submit" after selecting permissions
5. Generate a new token`;
                }
                
                showResult(errorMessage, 'error');
                return false;
            }
        }
        
        async function saveToken() {
            const token = document.getElementById('newToken').value.trim();
            
            if (!token) {
                showResult('‚ùå Please paste your token first.', 'error');
                return;
            }
            
            // First validate the token
            const isValid = await validateToken();
            if (!isValid) {
                return;
            }
            
            showResult('üíæ Saving token to your VidShare database...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        key: 'dropbox_token',
                        value: token
                    })
                });

                if (!response.ok) {
                    throw new Error(`Supabase error: ${response.status} - ${await response.text()}`);
                }

                showResult(`üéâ SUCCESS! 

Your new Dropbox token has been saved to VidShare!

‚úÖ Token validated with Dropbox
‚úÖ Saved to Supabase database  
‚úÖ VidShare is now fully functional

You can now create galleries from your Dropbox folders!`, 'success');

                // Show the final success message
                document.getElementById('finalSuccess').style.display = 'block';
                document.getElementById('finalSuccess').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showResult(`‚ùå Error saving token to database: ${error.message}

The token is valid but couldn't be saved. Please check your Supabase connection.`, 'error');
            }
        }
        
        function openAdminPanel() {
            window.open('/mobley/', '_blank');
        }
        
        function runFullTest() {
            window.open('/test_functionality.html', '_blank');
        }
        
        // Auto-focus the token input
        window.addEventListener('load', () => {
            document.getElementById('newToken').focus();
        });
    </script>
</body>
</html>
